#!/bin/bash

#
# mkdotfile DOTFILE_PATH TARGET_NAME GROUP_NAME1 ...: construct dotfile
# DOTFILE_PATH for target TARGET_NAME by concatenating the dotfiles from each of
# the named groups.
#

arg0=$(basename $0)

function fail
{
	echo "$arg0: $@" >&2
	exit 1
}

if [[ $# -lt 3 ]]; then
	echo "usage: $arg0 DOTFILE_PATH TARGET_NAME GROUP_NAME1 ..." >&2
	echo "construct a dotfile for TARGET_NAME from the given groups." >&2
	exit 2
fi

md_dotfile="$1"
md_target="$2"
md_finalfile="$md_target/$md_dotfile"
md_tmpfile="$md_finalfile.tmp"
shift 2

mkdir -p "$(dirname "$md_finalfile")" || fail "mkdir failed"
cat >> $md_tmpfile << EOF || fail "failed to create \"$md_tmpfile\""
#
# file auto-generated by $arg0 on $(date)
EOF

for group in "$@"; do
	groupfile="$group/$md_dotfile"
	if ! [[ -f $groupfile ]]; then
		echo "skip: $groupfile (not a file)" >&2
		continue
	fi

	cat >> $md_tmpfile <<-EOF
	# begin include from $groupfile
	#
	EOF

	cat $groupfile >> $md_tmpfile

	cat >> $md_tmpfile <<-EOF
	#
	# end include from $groupfile
	EOF
done

echo "#" >> $md_tmpfile
mv $md_tmpfile $md_finalfile
